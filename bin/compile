#!/bin/bash

APP_DIR="$1"
ENV_DIR="$3"

# load required environment variables
ROOT_DIR=$(<"$ENV_DIR/ROOT_DIR")

if [[ -z $ROOT_DIR ]]; then
    echo "Did you forget to set ROOT_DIR?"
    exit 1
fi

# make sure we're in the root of the app dir
cd "$APP_DIR"

TEMP_DIR="__root__"
mkdir -p $TEMP_DIR

ADDITIONAL_BUILD_ROOT=$(mktemp -d /tmp/buildpack.XXXXXXXXX)
# Make sure the directory exists (althought mktemp should create it)
mkdir -p $ADDITIONAL_BUILD_ROOT

# copy all the files from current root into the temporary build root
cp -a "${ROOT_DIR}/." "$ADDITIONAL_BUILD_DIR"

# copy the contents of the specified root into the
# the temp root
cp -a "$ROOT_DIR/." "$TMP_DIR"

# remove everything besides the new root
shopt -s extglob
rm -rf -- !($TMP_DIR)

# move everything out of the temp dir into
# the actual root
shopt -s dotglob nullglob
mv ${TMP_DIR}/* .

# remove the temp dir
rm -r $TEMP_DIR

# Point all the relative paths in the node dependencies to the new temp-folder
find $BUILD_DIR -maxdepth 2 -type f -name package.json -or -name yarn.lock |
    perl -p -i -e "s%file:\.\./%file:${ADDITIONAL_BUIlD_ROOT}/%s"
